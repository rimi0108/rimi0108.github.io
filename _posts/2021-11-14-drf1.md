---
title: "[Django] DRFë¡œ íšŒì›ê°€ì… ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸° - (1)"
excerpt: "django rest frameworkë¡œ íšŒì›ê°€ì… ê¸°ëŠ¥ êµ¬í˜„í•´ë³´ê¸° (Feat. custom user model)"

categories:
  - Django
tags:
  - [drf]

toc: true
toc_sticky: true

date: 2021-11-14
last_modified_at: 2021-11-14
---

## íšŒì›ê°€ì… ê¸°ëŠ¥ êµ¬í˜„í•´ë³´ê¸°

> í•„ìëŠ” [drf ê³µì‹ë¬¸ì„œ tutorial](https://www.django-rest-framework.org/tutorial/quickstart/) ì„ í†µí•´ì„œ ê¸°ë³¸ì ì¸ íšŒì›ê°€ì… ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë†“ì€ ìƒíƒœì…ë‹ˆë‹¤.

_drfë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  êµ¬í˜„í–ˆë˜ íšŒì›ê°€ì… ê¸°ëŠ¥ì€ ì´ì œ ì¢€ í•´ë´¤ë‹¤ê³  ìµìˆ™í•´ì¡Œì§€ë§Œ drfë¥¼ ì ìš©í•˜ë‹ˆ ìµìˆ™í–ˆë˜ ê²Œ ì •ë§ ì–´ë ¤ì›Œì§„ë‹¤. ğŸ˜° í•˜ì§€ë§Œ drfì™€ ì¹œí•´ì§€ëŠ” ì‹œê°„ì„ ë§ì´ ê°€ì ¸ì•¼ í•  ê²ƒ ê°™ê¸° ë•Œë¬¸ì— drfë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ê¸°ë¡œ í–ˆë‹¤._

<img width="1207" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-11-14 á„‹á…©á„’á…® 11 33 41" src="https://user-images.githubusercontent.com/73830753/141685621-d630b342-f218-468c-9400-3c1aa53a0ee3.png">

ì¼ë‹¨ ìœ„ ê³µì‹ë¬¸ì„œ tutorialì„ ì˜ ë”°ë¼í•˜ë©´ `http://127.0.0.1:8000/users/`ì— ì ‘ì†í–ˆì„ ë•Œ user ì •ë³´ë¥¼ post í•  ìˆ˜ ìˆëŠ” í™”ë©´ì´ ì˜ ëœ¬ë‹¤.
<img width="1212" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-11-14 á„‹á…©á„’á…® 11 38 33" src="https://user-images.githubusercontent.com/73830753/141685831-3dfaf9fe-24e5-4e0c-b8e2-b80cb45540f7.png">
í”„ë¡œì íŠ¸ì™€ ì—°ê²°ëœ dbì˜ `auth_user` í…Œì´ë¸”ì„ í™•ì¸í•˜ë©´ user ì •ë³´ê°€ ì˜ ë“¤ì–´ê°„ ê±¸ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.

ê·¸ëŸ°ë° í•˜ë‚˜ì˜ userë¥¼ ë” ì¶”ê°€í•˜ë ¤ê³  í•˜ë‹ˆ `1062, "Duplicate entry "For key 'username'"` ì´ë¼ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤. ì•„ë§ˆ usernameì´ uniqueí•œ í•„ë“œë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ë° usernameì„ serializerì— ë„£ì§€ ì•Šìœ¼ë‹ˆ ë¹ˆ ë¬¸ìì—´ë¡œ ë“¤ì–´ê°€ì„œ usernameì´ ì¤‘ë³µë˜ì–´ ë°œìƒí•œ ë¬¸ì œê°™ì•˜ë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ usernameì˜ `unique=True` ì˜µì…˜ì„ ë³€ê²½í•´ì¤˜ì•¼ í•  ê²ƒ ê°™ë‹¤. ê·¸ë¦¬ê³  dbì— passwordê°€ ì…ë ¥í•œ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°€ì„œ ë³´ì•ˆì„ ìœ„í•´ passwordë¥¼ ì•”í˜¸í™”í•˜ì—¬ dbì— ë„£ì–´ì£¼ì–´ì•¼ í•  ê²ƒ ê°™ë‹¤. ì´ ë¬¸ì œë“¤ì„ ì°¨ê·¼ì°¨ê·¼ í•´ê²°í•´ë³´ì! ì´ë²ˆ ê¸€ì—ì„œëŠ” django ìœ ì € ê¸°ë³¸ ëª¨ë¸ì„ ë³€ê²½í•´ì£¼ì–´ ì²«ë²ˆì§¸ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ê² ë‹¤.

## table field ì˜µì…˜ ë³€ê²½

ì°¾ì•„ë³´ë‹ˆ djangoì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ëŠ” ìœ ì € ëª¨ë¸ì€ ë¡œê·¸ì¸í•  ë•Œ usernameìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ëœë‹¤ê³  í•œë‹¤.(ê·¸ë˜ì„œ unique=True ì˜µì…˜ì„ ì¤¬ë‚˜ë³´ë‹¤.) ê·¸ë˜ì„œ ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì„ ë§Œë“¤ê¸°ë¡œ í–ˆë‹¤!

### Custom user model

#### model ì‘ì„±í•˜ê¸°

```python
# accounts/models.py
from django.db import models
from django.contrib.auth.models import BaseUserManager, AbstractBaseUser


class UserManager(BaseUserManager):
    def create_user(self, email, password=None):
        if not email:
            raise ValueError("Users must have an email address")

        user = self.model(email=self.normalize_email(email))
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password):
        user = self.create_user(email, password=password)
        user.is_admin = True
        user.save(using=self._db)
        return user


class User(AbstractBaseUser):
    email = models.EmailField(
        verbose_name="email",
        max_length=255,
        unique=True,
    )
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)

    objects = UserManager()

    USERNAME_FIELD = "email"

    def __str__(self):
        return self.email

    def has_perm(self, perm, obj=None):
        return True

    def has_module_perms(self, app_label):
        return True

    @property
    def is_staff(self):
        return self.is_admin
```

accounts ì•±ì— ìˆëŠ” `models.py` íŒŒì¼ì— ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•´ì¤€ë‹¤. ìì„¸íˆ ëœ¯ì–´ë³´ì!

```python
from django.db import models
from django.contrib.auth.models import BaseUserManager, AbstractBaseUser
```

ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” `BaseUserManager`ì™€ `AbstractBaseUser`ë¼ëŠ” ë‘ ê°œì˜ í´ë˜ìŠ¤ê°€ í•„ìš”í•˜ë‹¤ê³  í•œë‹¤. `BaseUserManager` í´ë˜ìŠ¤ëŠ” ìœ ì €ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì„ ë•ëŠ” í´ë˜ìŠ¤ì´ë©°, ì‹¤ì œ ëª¨ë¸ì€ `AbstractBaseUser`ì„ ìƒì†ë°›ì•„ ìƒì„±ë˜ëŠ” í´ë˜ìŠ¤ì´ë‹¤.

```python
class UserManager(BaseUserManager):
    def create_user(self, email, password=None):
        if not email:
            raise ValueError("Users must have an email address")

        user = self.model(email=self.normalize_email(email))
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password):
        user = self.create_user(email, password=password)
        user.is_admin = True
        user.save(using=self._db)
        return user
```

`BaseUserManager`ë¥¼ ìƒì†ë°›ì€ `UserManager` í´ë˜ìŠ¤ëŠ” í—¬í¼ í´ë˜ìŠ¤ì´ë‹¤. ì´ í´ë˜ìŠ¤ëŠ” ë‘ ê°€ì§€ í•¨ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆë‹¤. í•¨ìˆ˜ì˜ email parameterëŠ” ì›ë˜ usernameì´ ë“¤ì–´ê°€ëŠ”ë°, ìš°ë¦¬ëŠ” username ëŒ€ì‹  emailì„ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ emailì„ ì „ë‹¬í•œë‹¤.

```python
class User(AbstractBaseUser):
    email = models.EmailField(
        verbose_name="email",
        max_length=255,
        unique=True,
    )
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)

    objects = UserManager()

    USERNAME_FIELD = "email"

    def __str__(self):
        return self.email

    def has_perm(self, perm, obj=None):
        return True

    def has_module_perms(self, app_label):
        return True

    @property
    def is_staff(self):
        return self.is_admin
```

ìœ„ëŠ” Userì˜ ì‹¤ì œ ëª¨ë¸ì´ë‹¤. ì´ ëª¨ë¸ì€ email, is_active, is_admin í•„ë“œë¥¼ ê°€ì§€ê³  ìˆë‹¤. is_active, is_admin í•„ë“œëŠ” djangoì˜ ìœ ì € ëª¨ë¸ì˜ í•„ìˆ˜ í•„ë“œì´ë‹¤.

```
    objects = UserManager()

    USERNAME_FIELD = "email"
```
ìœ„ëŠ” User ëª¨ë¸ì„ ìƒì„±í•˜ê¸° ìœ„í•´ ê¼­ í•„ìš”í•œ ë¶€ë¶„ì´ë‹¤. ìš°ë¦¬ê°€ ë§Œë“  í—¬í¼ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìœ¼ë©°, username í•„ë“œë¥¼ emailë¡œ ì‚¬ìš©í•˜ê²Œ í•˜ì˜€ë‹¤.

#### ê´€ë¦¬ì í˜ì´ì§€ ìˆ˜ì •

djangoì˜ admin í˜ì´ì§€ë¥¼ í†µí•´ userë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ê¸°ì¡´ django admin formì„ ì»¤ìŠ¤í…€í•œ ìœ ì € ëª¨ë¸ì— ë§ê²Œ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.

`forms.py` ë¼ëŠ” íŒŒì¼ì„ ì•±ì•ˆì—ë‹¤ ìƒì„±í•œë‹¤.

```python
# accounts/forms.py
from django import forms
from django.contrib.auth.forms import ReadOnlyPasswordHashField

from .models import User


class UserCreationForm(forms.ModelForm):
    password1 = forms.CharField(label='Password', widget=forms.PasswordInput)
    password2 = forms.CharField(
        label='Password confirmation', widget=forms.PasswordInput)

    class Meta:
        model = User
        fields = ('email',)

    def clean_password2(self):
        password1 = self.cleaned_data.get("password1")
        password2 = self.cleaned_data.get("password2")
        if password1 and password2 and password1 != password2:
            raise forms.ValidationError("Passwords don't match")
        return password2

    def save(self, commit=True):
        user = super().save(commit=False)
        user.set_password(self.cleaned_data["password1"])
        if commit:
            user.save()
        return user


class UserChangeForm(forms.ModelForm):
    password = ReadOnlyPasswordHashField()

    class Meta:
        model = User
        fields = ('email', 'password', 'is_active', 'is_admin')

    def clean_password(self):
        return self.initial["password"]
```
ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

#### admin í˜ì´ì§€ì— form ì ìš©

ì‘ì„±í•œ formì„ admin í˜ì´ì§€ì— ì ìš©í•˜ê¸° ìœ„í•´ ì•±ì•ˆì˜ `admin.py` íŒŒì¼ì„ ìˆ˜ì •í•´ì¤€ë‹¤.

```python
# accounts/admin.py
from django.contrib import admin
from django.contrib.auth.models import Group
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin

from .forms import UserChangeForm, UserCreationForm
from .models import User


class UserAdmin(BaseUserAdmin):
    form = UserChangeForm
    add_form = UserCreationForm

    list_display = ('email', 'is_admin')
    list_filter = ('is_admin',)
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Permissions', {'fields': ('is_admin',)}),
    )

    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'password1', 'password2')}
         ),
    )
    search_fields = ('email',)
    ordering = ('email',)
    filter_horizontal = ()


admin.site.register(User, UserAdmin)
admin.site.unregister(Group)
```
ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

#### ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ ë“±ë¡
```python
# í”„ë¡œì íŠ¸í´ë”/settings.py
AUTH_USER_MODEL = "accounts.User"
```

ìì‹ ì˜ í”„ë¡œì íŠ¸ í´ë”ì•ˆì— ìˆëŠ” `settings.py` íŒŒì¼ì— ìœ„ì™€ ê°™ì€ ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤. `"ì•±ì´ë¦„.User"`ë¡œ ì‘ì„±í•œë‹¤.

#### í…Œì´ë¸” ìƒì„±

ìœ„ ì½”ë“œë“¤ì„ ë‹¤ ì‘ì„±í•˜ë©´ makemigrationsê³¼ migrateë¥¼ í†µí•´ db í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤.

â— ì´ ë•Œ ì£¼ì˜í•´ì•¼ í•  ì ì€ ì‘ì„±í•´ë†¨ë˜ `views.py` íŒŒì¼ì— 
```python
from django.contrib.auth import User
```
ë¡œ ë¶ˆëŸ¬ì™”ë˜ ëª¨ë¸ì„
```python
from django.contrib.auth import get_user_model

User = get_user_model()
```
ìœ„ ì½”ë“œë¡œ ë³€ê²½í•´ì£¼ì–´ì•¼ í•œë‹¤. ë³€ê²½í•´ì£¼ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ì´ê²ƒ ë•Œë¬¸ì— í•œì°¸ í—¤ë§¸ë‹¤.. í•˜í•˜.. ğŸ˜­ views íŒŒì¼ ë¿ë§Œ ì•„ë‹ˆë¼ ëª¨ë¸ì„ import í•œ ëª¨ë“  íŒŒì¼ì„ ì»¤ìŠ¤í…€ ëª¨ë¸ë¡œ ë³€ê²½í•´ì£¼ì–´ì•¼ í•œë‹¤.

```
+------------------------+
| Tables_in_django       |
+------------------------+
| accounts_user          |
| auth_group             |
| auth_group_permissions |
| auth_permission        |
| django_admin_log       |
| django_content_type    |
| django_migrations      |
| django_session         |
+------------------------+
```
í…Œì´ë¸”ì„ í™•ì¸í•˜ë©´ ìœ„ì™€ ê°™ì´ account_user í…Œì´ë¸”ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
+------------+--------------+------+-----+---------+----------------+
| Field      | Type         | Null | Key | Default | Extra          |
+------------+--------------+------+-----+---------+----------------+
| id         | int(11)      | NO   | PRI | NULL    | auto_increment |
| password   | varchar(128) | NO   |     | NULL    |                |
| last_login | datetime(6)  | YES  |     | NULL    |                |
| email      | varchar(255) | NO   | UNI | NULL    |                |
| is_active  | tinyint(1)   | NO   |     | NULL    |                |
| is_admin   | tinyint(1)   | NO   |     | NULL    |                |
+------------+--------------+------+-----+---------+----------------+
```
ìœ„ì™€ ê°™ì€ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆê°€ ë§Œë“¤ì–´ì¡ŒëŠ”ë°, emailì´ unique í•„ë“œë¡œ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ìƒì„±ëœ í…Œì´ë¸”ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ userë¥¼ ìƒì„±í•´ë³´ë©´

```
+----+-----------+------------+-----------------+-----------+----------+
| id | password  | last_login | email           | is_active | is_admin |
+----+-----------+------------+-----------------+-----------+----------+
|  1 | abcd1234! | NULL       | user1@gmail.com |         1 |        0 |
|  2 | abcd1234! | NULL       | user2@gmail.com |         1 |        0 |
+----+-----------+------------+-----------------+-----------+----------+
```

ë‹¤ìˆ˜ì˜ userê°€ ì˜ ë“¤ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


### <ì°¸ê³ >

- https://dev-yakuza.posstree.com/ko/django/custom-user-model/
